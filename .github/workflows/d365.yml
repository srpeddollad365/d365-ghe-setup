name: D365 Solution CI/CD
on:
  push:
    branches:
      - main
  workflow_dispatch: 
env:
  SOLUTION_NAME: test
 
jobs:
  build-and-deploy:
    runs-on: windows-latest
 
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
 
      - name: Install Power Platform CLI
        uses: microsoft/powerplatform-actions/install@v1
 
      - name: Authenticate to Power Platform
        uses: microsoft/powerplatform-actions/authenticate@v1
        with:
          tenant-id: ${{ secrets.TENANTID }}
          client-id: ${{ secrets.CLIENTID }}
          client-secret: ${{ secrets.CLIENTSECRETVALUE }}
          environment-url: ${{ secrets.PP_DEV_URL }}
 
      - name: Export solution
        uses: microsoft/powerplatform-actions/export-solution@v1
        with:
          solution-name: ${{ env.SOLUTION_NAME }}
          solution-output-file: solutions/${{ env.SOLUTION_NAME }}.zip
          managed: false
 
      - name: Unpack solution
        uses: microsoft/powerplatform-actions/unpack-solution@v1
        with:
          solution-file: solutions/${{ env.SOLUTION_NAME }}.zip
          target-folder: solutions/${{ env.SOLUTION_NAME }}
          solution-type: Unmanaged
 
      - name: Commit solution to repo
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add solutions
          git commit -m "Export solution ${{ env.SOLUTION_NAME }}" || echo "No changes"
          git push